#!/Melify/bin/mac/tclkit

set date "2019-11-19"
set symbol "AAPL"
set start  "B"

############################

source "~/Dropbox/Trader/stocks/$symbol/$date/$symbol.txt"

for {set nticks 3} {$nticks < 10} {incr nticks} {
    set u 0; set d 0; set p 0;  set bp 0;  set sp 0; 

    file mkdir ./compare/q1
    set f [open ./compare/q1/$nticks.dat w]

    puts "ticks = $nticks"
    
    puts $f "ticks = $nticks"
    puts $f "------------------------------------------------------------------------"
    puts $f "  X PRICE     VOLUME  TIME            BIDs  ASKs  BIDp        ASKp"
    puts $f "------------------------------------------------------------------------"

    foreach k [dict key $stocks] {
	foreach {i j} [dict get $stocks $k] {
	    set a($i) $j
	}
	
	if {$a(lastPrice) > $p} {
	    # PRICE IS UP (S)
	    incr u; set d 0
	} elseif {$a(lastPrice) < $p} {
	    # PRICE IS DOWN (B)
	    incr d; set u 0
	}

	set fmt "%3s %5.4f0 %d %d %5d %5d %10.4f0 %10.4f0"

	if {$u == $nticks && $start == "S" && $a(lastPrice) > $bp} {
	    puts $f [format $fmt "S" $a(lastPrice) $a(totalVolume) $a(quoteTimeInLong) $a(bidSize) $a(askSize) $a(bidPrice) $a(askPrice)]
	    set u 0;set d 0
	    set start "B"
	    puts $f ""
	    set sp $a(lastPrice)
	}

	if {$d == $nticks && $start == "B" && $a(lastPrice) > $sp} {
	    puts $f [format $fmt "B" $a(lastPrice) $a(totalVolume) $a(quoteTimeInLong) $a(bidSize) $a(askSize) $a(bidPrice) $a(askPrice)]
	    set u 0;set d 0
	    set start "S"
	    set bp $a(lastPrice)
	}

	# SAVE IT FOR NEXT ROUND
	set p $a(lastPrice)
    }

    close $f
}

