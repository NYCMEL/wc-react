#!/Melify/bin/mac/tclkit

if {$argc != 1} {
    puts "\nUSAGE: codegen <file-name>\n"
    exit
}

lappend auto_path\
    /Melify/mtk/dev/tk/src/utl\
    /Melify/mtk/dev/tk/src/cgi\
    /Melify/mtk/dev/tk/src/utl\
    /Melify/mtk/dev/tk/src/db\
    /Melify/mtk/dev/tk/src/eng

######################################################
##### 
######################################################
set fi [open $argv r]
set fo [open out.$argv w]

set settings		""
set ENV			"dev"
set env(REMOTE_ADDR)	"127.0.0.1"
set env(HTTP_HOST)	"localhost"
set root "/Melify/mtk/dev/tk/lib/components/fm/components"

######################################################
##### 
######################################################
proc parse {line} {
    global cfg settings

    catch {unset cfg}

    set line [string range $line 5 end-1]
    regsub -all "\"" $line "" line

    foreach i [split $line] {
	set j [split $i =]
	set cfg([lindex $j 0]) [lindex $j 1]
    }

    if {[file exist $cfg(config)] == 1} {
	set c [file:read $cfg(config)]
	set settings [json::json2dict $c]
    }
}

######################################################
##### 
######################################################
proc generate {line} {
    global fi fo cfg settings

    if {$settings != ""} {
	set id [dict get $settings id]

	set menus ""
	foreach i [dict get $settings menus] {
	    lappend menus [dict get $i id] [dict get $i label]
	}

	# PREPARE VARIABLE FOR TEST PROC
	set ::menus	$menus
	set ::isolate	0
	set ::id	$id
	set ::logo	"[dict get $settings logo]"
    }

    parray cfg

    set dir $::root/$cfg(component)/fm.component.$cfg(component).$cfg(version)
    puts ==$dir==

    lappend ::auto_path $dir

    set comp "fm::component::$cfg(component)"
    puts $comp

    # ADD ALL REQUIRED SCRIPTS
    puts $fo [cgi_buffer {${comp}::isolate}]
    puts $fo [cgi_buffer {${comp}::test}]
}

######################################################
##### 
######################################################
proc process {line} {
    global fi fo cfg settings

    parse $line

    if {$cfg(update) == "true"} {
	#CLEAR ALL PRIOR CODE
	while {[gets $fi tmp] >= 0} {
	    if {[string first "</mtk>" $tmp] !=-1} {
		generate $line
		break
	    }
	}

	puts $fo "</mtk>"
    }
}

######################################################
##### 
######################################################
while {[gets $fi line] >= 0} {
    puts $fo $line

    set line [string trim $line]

    if {[string first "<mtk " $line] !=-1} {
	#FOUND A COMPONENT
	process $line
    }
}
