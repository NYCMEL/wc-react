#!/Melify/bin/mac/tclkit

source "/Melify/mtk/dev/tk/src/utl/json2dict.tcl"

########################################################################################
#### CONVERT TCL ARRAY TO JSON
########################################################################################
proc d2j {symbol} {
    source "/Users/melify/Dropbox/Trader/stocks/$symbol/2019-11-19/$symbol.txt"

    set res "\["
    foreach k [dict key $stocks] {
	foreach {i j} [dict get $stocks $k] {
	    set a($i) $j

	    set tstr ""
	    foreach k [array names a] {
		append tstr "\"$k\":\"$a($k)\","
	    }
	}
	set tstr [string replace $tstr end end]
	append res "\{$tstr\},"
    }

    set res [string replace $res end end]
    append res "\]"

    return $res
}

########################################################################################
#### CREATE JSON FILES FROM TCL DATA
########################################################################################
foreach i [glob /Users/melify/Dropbox/Trader/stocks/*] {
    if {[file isdir $i] == 1} {
	set sym [file tail $i]
	set fo [open "/Users/melify/Dropbox/Trader/stocks/$sym/2019-11-19/$sym.json" w]
	puts $fo [d2j $sym]
	close $fo

	puts "/Users/melify/Dropbox/Trader/stocks/$sym/2019-11-19/$sym.json"
    }
}
