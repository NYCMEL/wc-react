#!/Melify/bin/mac/tclkit

#######################################################
###### SERVER CODE
#######################################################
source /Melify/mtk/dev/tk/src/cgi/cgi.tcl

#FOR TESTING ONLY.
set ENV		"dev"
set env(HOME)	"/"

catch {
    source ../app.cfg
}

lappend auto_path\
    /Melify/mtk/$ENV/tk/src\
    /Melify/mtk/$ENV/tk/src/utl\
    /Melify/mtk/$ENV/tk/src/db\
    /Melify/mtk/$ENV/tk/src/eng

#DUMMY IT UP
proc Trace {args} {}

cgi_input
foreach i [import_list] {
    import $i
}

#FOR TESTING ONLY. THIS SHOULD NEVER BE THE CASE
if {[info exist key] == 0} {set key "TEST"}

#RETURN A JSON RESULT
switch $key {
    "TEST" {
	puts [subst {
	    \[{id:"[clock seconds]", result:"Mel Heravi"}\]
	}]
    }
    "QUERY" {
	if {[catch {
	    tk::use:db "/Melify/mtk/dev/app/_full/db/sqlite.db"
	    sqlite dbh $::DB

	    set res [dbh eval "select id,fname,lname from users where id=$id"]
	    
	    puts [subst {
		\[{id:"[lindex $res 0]", fname:"[lindex $res 1]", lname:"[lindex $res 2]"}\]
	    }]
	} e] != 0} {
	    puts [subst {
		\[{id:"UNDEFINED", result:"$e"}\]
	    }]
	}
    }
    default {
	puts [subst {
	    \[{id:"UNDEFINED", fname:"UNDEFINED" , lname:"UNDEFINED"}\]
	}]
    }
}
