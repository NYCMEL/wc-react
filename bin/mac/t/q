#!/Melify/bin/mac/tclkit

namespace eval queue {
    set data [list]
    set nticks 0
    set start "B"

    array set ticks {}
    array set tickb {}

    ######################################################
    ####
    ######################################################
    proc init {nticks} {
	set queue::data [list]
	set queue::nticks $nticks
    }

    ######################################################
    ####
    ######################################################
    proc add {} {
	upvar ctick ctick
	lappend queue::data $ctick(lastPrice)
	
	if {[llength $queue::data] > $queue::nticks} {
	    set queue::data [lrange $queue::data end-[expr $queue::nticks -1] end]
	}
	
	dir
    }
    
    ######################################################
    ####
    ######################################################
    proc dir {} {
	upvar ctick ctick

	if {[llength $queue::data] != $queue::nticks} {
	    return
	}

	set s1 [lsort -increasing -real $queue::data]
	set s2 [lsort -decreasing -real $queue::data]
	
	if {$s1 == $queue::data} {
	    if {$queue::start != "B"} {
		array set queue::ticks [array get ctick]

		if {$queue::tickb(lastPrice) < $queue::ticks(lastPrice)} {
		    puts "S: $queue::data\n"
		    
		    # RESET START
		    set queue::start "B"
		}
	    }
	}

	if {$s2 == $queue::data} {
	    if {$queue::start != "S"} {
		array set queue::tickb [array get ctick]
		puts "B: $queue::data"
		
		# RESET START
		set queue::start "S"
	    }
	}
    }
}

######################################################
####
######################################################
proc test {nticks date symbol timeout} {
    queue::init $nticks

    source "~/Dropbox/Trader/stocks/AAPL/$date/$symbol.txt"

    foreach k [dict key $stocks] {
	foreach {i j} [dict get $stocks $k] {
	    set ctick($i) $j
	}
	
	#puts -nonewline ".";flush stdout
	
	queue::add

	after $timeout
    }
}

#RUN TEST SCRIPT
test 5 2019-11-19 AAPL 10
